<!DOCTYPE html>
<html>
	<head>
		<title>Container inside a rotator v2</title>
		<link rel="stylesheet" type="text/css" href="../css/gameboard.css">
		<script src="js/jQuery_v2_1_3.js"></script>
		<script src="js/jquery.easing.1.3.js"></script>
		<script src="js/e-smart-hittest-jquery.js"></script>
		<script src="js/OSC.js"></script>
		<script src="js/gameBoard.js"></script>
		<script src="js/CLASS.js"></script>
		<script src="js/Tile.js"></script>
		<script src="js/InteractiveTile.js"></script>
		<script src="js/DoorTile.js"></script>
		<script src="js/animationFrame.js"></script>

	</head>
	
	<body>
		<div id="mask"><div id='rotater'></div></div>
		<div id='character'></div>
		<script>
		
			var row 	= 	0;
			var column 	= 	0;
			var colMax	= 	13;
			var rowMax	=	17;
			var angle = 0;
			var containerRotation = 0;
			var canMoveForward = true;
			var divMDArray = Array();
			//buildArray();
			addContainer();
			buildFloor();
			$(document).keypress(alertKey);
			
			
			
			
			function buildFloor(){
				var max = gameboard.length;
				for(var i = 0; i<max; i++){
					addSprite(i);
				}
			}
			
			
			function addContainer(){
				var newDiv = document.createElement('div');
				var id = "container";
				newDiv.id = id;
				O('rotater').appendChild(newDiv); 
				$('#container').css('width',colMax*50);
				$('#container').css('height',rowMax*50);
			}
			
			
			function addSprite(id){
				divMDArray.push(createSprite(id));
				
			}
			
			
			
			function createSprite(id){
				var classAcronym = gameboard[id].type;
				var className = gameBoardClasses[classAcronym];	
				var imagePath = gameBoardImageLookup[classAcronym];
				
				if (className.match(/interactive/gi) == null ){
					var newTile = new Tile();
				} else if(className.match(/door/gi) != null){
					var newTile = new DoorTile();
				}else{
					var newTile = new InteractiveTile();
				}
				var spriteID = 'sprite_'+id;
				var container = "container";		
				var x = gameboard[id].x + 25;
				var y = gameboard[id].y + 25;
				var w = gameboard[id].w;
				var h = gameboard[id].h;
				newTile.init(container, spriteID, className, x, y,w,h,imagePath, 0);
				return {_name:newTile.getID(), _classReference:newTile};
				
				
			}
			
			function showName(){
				
		        var id = $(this).attr("id");
		
			}
			
			/* this is the only part we will change for mobile, use joystick instead of keypress*/
			function alertKey(event){
				key = (event.which)
				if(String.fromCharCode(key) == "x"){
					finishLastMove();	
					rotateSpriteSheet(angle -= 180, 180);
				}
				if(String.fromCharCode(key) == "w"){
					finishLastMove();
					correctMoveForward();
				}
				if(String.fromCharCode(key) == "a"){
					finishLastMove();
					rotateSpriteSheet(angle += 90);
				}
				if(String.fromCharCode(key) == "d"){
					finishLastMove();
					rotateSpriteSheet(angle -= 90);
				}
				/*button press / interact with object*/
				if(String.fromCharCode(key) == "s"){
					var predictedObject = checkForHit();
					var isInteractive = $('#' + predictedObject._name).hasClass( "interactive" );
					if(isInteractive){
						var classRef = predictedObject._classReference;
						classRef.actedUpon();
					}
				}
			}
			
			function finishLastMove(){
				$('#rotater').finish();
				$('#container').finish();
			}
			
			function checkForHit(){
				var hitObstacle = catchHit();
				//console.log(hitObstacle[1].length);
				if(hitObstacle[0]){
					canMoveForward = false;
					resetPosition(hitObstacle[1]);
				}else{
					canMoveForward = true;
				}
				return (hitObstacle[1]);
				
			
			}
			
			function resetPosition(){
				var distance = 5;
					switch(containerRotation){
						case 0:
							
							$('#container').animate( {left:"+=0", top:"-="+distance }, 0);
							break;
						case 90:
							
							$('#container').animate( {left:"-="+distance, top:"+=0" }, 0);
							break;
						case 180:
							
							$('#container').animate( {left:"+=0", top:"+="+distance }, 0);
							break;
						case 270:
							
							$('#container').animate( {left:"+="+distance, top:"+=0" }, 0);
							break;
				}
			}


			
			

			
			
			
			function catchHit(){
				
				var hits = new Array();
				for(var i = 0; i<divMDArray.length; i++){
					var k = '#' + divMDArray[i]._name;
					var hit = $('#character').objectHitTest({"object":$(k)});
					if(hit){
						//$(k).css("border","1px solid red");

						hits.push(divMDArray[i]);
					}
				}
				var obstacles = new Array();
				if(hits.length>0){
					for(var i = 0; i<hits.length; i++){
						var predict = hits[i];
						var k = '#' + predict._name;
						if($(k).hasClass( "obstacle" )){
							obstacles.push(predict);
							// for doors check for a state called open. If open ignore and return false
							//console.log(predict._classReference.getClass());
						}
					}
					
				}
				if(obstacles.length > 0){
					return ([true, obstacles]);
				}else{
					return ([false, obstacles]);
				}
				
			}
			
			
			
			function rotateSpriteSheet(degrees, rot){
				canMoveForward = true;
				var remainder = (degrees/360)%1;
				if(remainder < 0){
					var percent = 1 + remainder;	
				}else{
					var percent = remainder;
				}
				containerRotation = 360 * percent;
				if(rot != 180){
					var _duration = 300;
				}else{
					var _duration = 600;
				}
				
				$('#rotater').animate(
										{target: degrees}, 
											{step: function(now,fx) {
														$(this).css('-webkit-transform','rotate('+now+'deg)'); 
														$(this).css('-moz-transform','rotate('+now+'deg)');
														$(this).css('transform','rotate('+now+'deg)');
												   }
													,duration:_duration,
													easing:'easeOutCirc',
													complete:rotateSprite
											});
				
			}
			
			function correctMoveForward(position){
				var distance = 5;
				if(canMoveForward){
					
					switch(containerRotation){
						case 0:
							$('#container').animate( {left:"+=0", top:"+="+distance }, 100, 'swing',checkForHit);
							break;
						case 90:
							$('#container').animate( {left:"+="+distance, top:"+=0" }, 100, 'swing',checkForHit);
							break;
						case 180:
							$('#container').animate( {left:"+=0", top:"-="+distance }, 100, 'swing',checkForHit);
							break;
						case 270:
							$('#container').animate( {left:"-="+distance, top:"+=0" }, 100, 'swing',checkForHit);
							break;
					}
				}
				
			}
			
			function rotateSprite(){
				checkForHit();
			}
			

			
			function getRotationDegrees(obj) {
 			   var matrix = obj.css("-webkit-transform") ||
			    obj.css("-moz-transform")    ||
			    obj.css("-ms-transform")     ||
			    obj.css("-o-transform")      ||
			    obj.css("transform");
			    if(matrix !== 'none') {
			        var values = matrix.split('(')[1].split(')')[0].split(',');
			        var a = values[0];
			        var b = values[1];
			        var angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
			    } else { var angle = 0; }
			    return angle;
			}
			
			
			
			
		
		</script>
	
	</body>

</html>