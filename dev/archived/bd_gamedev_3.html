<!DOCTYPE html>
<html>
	<head>
		<title>Container inside a rotator v2</title>
		<link rel="stylesheet" type="text/css" href="../css/gameboard.css">
		<script src="js/jQuery_v2_1_3.js"></script>
		<script src="js/jquery.easing.1.3.js"></script>
		<script src="js/e-smart-hittest-jquery.js"></script>
		<script src="js/OSC.js"></script>
		<script src="js/gameBoard.js"></script>
		
		<style>
			
			.redBox { 	  position:absolute; 
					 	  width:50px;
						  height:50px;
						  background:red;	
			}
			
			
			#container{	  position:absolute;
						  width:600px;
						  height:600px;
						  left:0px;
						  top:0px;	
						  background:#fff;				  
			}
			
			#rotater{	  position:absolute;
						  width:600px;
						  height:600px;
						  left:0px;
						  top:0px;
						  transform-origin: 300px 300px;
						   -webkit-transform-origin: 300px 300px; /* Chrome, Safari, Opera */
						  
			}
			
			#character{	  position:absolute;
						  width:48px;
						  height:48px;
						  left:276px;
						  top:276px;
						  background-image: url("../img/gameDev/character.png");
						  background-repeat: no-repeat;
                          background-position: center ;
						  
						  	  /*position:absolute;
						  	  width:48px;
							  height:96px;
							  left:276px;
							  top:228px;
							  background-image: url("../img/gameDev/character.png");
							  background-repeat: no-repeat;
	                          background-position: center bottom ; 
							  background-color:orange;*/
						  
                          
    					  
			
			}
			
			#debug{		  position:absolute;
						  width:200px;
						  height:50px;
						  background:orange;
						  left:700px;
						  top:0px;
				
				
			}
			#mask{		  
						  position:absolute;
						  width:500px;
						  height:500px;
						  left:0px;
						  top:0px;
          				  clip: rect(100px,400px,400px,100px);
			}
			

			
			
			
		
		</style>
	</head>
	
	<body>
		<div id="mask"><div id='rotater'></div></div>
		<div id='character'></div>
		<div id='debug'>a</div>
		<script>
		
		/* build notes for tonight
		
			build an interactive javascript class that has a callback 
			should have an animated sequence
			should have an interacted state that sends a message back to the game
			
			
			get immediate matric AROUND CHARACTER FOR HIT TEST so that you have to check less.
		
		*/
		
			var row 	= 	0;
			var column 	= 	0;
			var colMax	= 	10;
			var rowMax	=	10;
			var angle = 0;
			var containerRotation = 0;
			var direction = 'horizontal';
			var canMoveForward = true;
			var divMDArray = Array();
			buildArray();
			addContainer();
			buildFloor();
			$(document).keypress(alertKey);
			
			
			function buildArray(){

				for(var i=0; i<colMax ; i++){
					divMDArray.push(Array());
				}
			}
			
			function buildFloor(){
				var max = colMax * rowMax;
				for(var i = 0; i<max; i++){
					addSprite();
				}
			}
			
			
			function addContainer(){
				var newDiv = document.createElement('div');
				var id = "container";
				newDiv.id = id;
				O('rotater').appendChild(newDiv); 
			}
			
			
			function addSprite(){
				
				if(row<rowMax){
					if(column < colMax){
						//createNewSprite
						divMDArray[row].push(createSprite(row,column));
						column++;
					}else{
						row++;
						column = 0;
						addSprite();
					}
				}else{
				}
			}
			
			function createSprite(row,col){
				var newDiv = document.createElement('div');
				var id = 'sprite'+"_"+row+"_"+col;
				newDiv.id = id;
				var classAcronym = gameboardMatrix[row][col];
				var _className = gameBoardLookup[classAcronym];
				O('container').appendChild(newDiv); 
				$('#'+id).css('left',(col * 50)+25);
				$('#'+id).css('top',(row * 50)+25);
				if(_className != 'floor'){
					$('#'+id).addClass(_className + " obstacle");
				}else{
					$('#'+id).addClass(_className);
				}
				
				$('#'+id).click(showName);
				
				return {_name:id, _class:_className};
				
				
			}
			
			function showName(){
				
		        var id = $(this).attr("id");
		
			}
			
			function alertKey(event){
				key = (event.which)
				if(String.fromCharCode(key) == "x"){
					$('#rotater').finish();
					$('#container').finish();
					var position = $('#container').position();	
					rotateSpriteSheet(angle -= 180);
				}
				if(String.fromCharCode(key) == "w"){
					$('#rotater').finish();
					$('#container').finish();
					correctMoveForward();
				}
				if(String.fromCharCode(key) == "a"){
					$('#rotater').finish();
					$('#container').finish();
					var position = $('#container').position();	
					rotateSpriteSheet(angle += 90);
				}
				if(String.fromCharCode(key) == "d"){
					$('#rotater').finish();
					$('#container').finish();
					var position = $('#container').position();	
					rotateSpriteSheet(angle -= 90);
				}
			}
			
			function checkForHit(){
				var hitObstacle = catchHit();
				if(hitObstacle == "true"){
					canMoveForward = false;
				}else{
					canMoveForward = true;
				}
				
			}
			
			function catchHit(){
				for(var i = 0; i<rowMax; i++){
					for(var j = 0; j<colMax; j++){
						var k = '#' + divMDArray[i][j]._name;
						var hit = $('#character').objectHitTest({"object":$(k)});
						if(hit){	
							switch(containerRotation){
								case 0:
									var predict = '#' + divMDArray[i-1][j]._name;
									break;
								case 90:
									var predict = '#' + divMDArray[i][j-1]._name;
									break;
								case 180:
									var predict = '#' + divMDArray[i+1][j]._name;
									break;
								case 270:
									var predict = '#' + divMDArray[i][j+1]._name;
									break;
							}
							if($(predict).hasClass( "obstacle" )){
								return ("true");
							} else{
								return ("false");
							}
						}
					}
				}
			}
			
			function rotateSpriteSheet(degrees){
				var remainder = (degrees/360)%1;
				if(remainder < 0){
					var percent = 1 + remainder;	
				}else{
					var percent = remainder;
				}
				containerRotation = 360 * percent;
				
				$('#rotater').animate(
										{target: degrees}, 
											{step: function(now,fx) {
														$(this).css('-webkit-transform','rotate('+now+'deg)'); 
														$(this).css('-moz-transform','rotate('+now+'deg)');
														$(this).css('transform','rotate('+now+'deg)');
												   }
													,duration:300,
													easing:'easeOutCirc',
													complete:rotateSprite
											});
				
			}
			
			function correctMoveForward(position){
				if(canMoveForward){
					switch(containerRotation){
						case 0:
							$('#container').animate( {left:"+=0", top:"+=50" }, 100, 'swing',checkForHit);
							break;
						case 90:
							$('#container').animate( {left:"+=50", top:"+=0" }, 100, 'swing',checkForHit);
							break;
						case 180:
							$('#container').animate( {left:"+=0", top:"-=50" }, 100, 'swing',checkForHit);
							break;
						case 270:
							$('#container').animate( {left:"-=50", top:"+=0" }, 100, 'swing',checkForHit);
							break;
					}
				}
				
			}
			
			function rotateSprite(){
				checkForHit();
			}
			

			
			function getRotationDegrees(obj) {
 			   var matrix = obj.css("-webkit-transform") ||
			    obj.css("-moz-transform")    ||
			    obj.css("-ms-transform")     ||
			    obj.css("-o-transform")      ||
			    obj.css("transform");
			    if(matrix !== 'none') {
			        var values = matrix.split('(')[1].split(')')[0].split(',');
			        var a = values[0];
			        var b = values[1];
			        var angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
			    } else { var angle = 0; }
			    return angle;
			}
			
			
			
			
		
		</script>
	
	</body>

</html>