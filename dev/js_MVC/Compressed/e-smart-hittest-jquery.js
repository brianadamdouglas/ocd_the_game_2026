(function($){$.fn.getRect=function(){var offset=this.offset();if(!offset)
return null;var formX=offset.left;var formY=offset.top;return new Rectangle(formX,formY,this.outerWidth(),this.outerHeight());};$.fn.hitTestPoint=function(options){var settings=$.extend({'x':0,'y':0,'transparency':false},options);var objectRect=this.getRect();var rectHitTest=objectRect.rectContainsPoint(settings.x,settings.y);var elementTarget=this[0];if(!settings.transparency||(!($(elementTarget).is("img"))&&!($(elementTarget).is("canvas"))))
return rectHitTest;if(!rectHitTest)
return false;var canvas=getCanvasFromElement(elementTarget);if(canvas==null)
return true;var ctx=canvas.getContext('2d');var imageData=ctx.getImageData(settings.x-objectRect.x,settings.y-objectRect.y,1,1);return imageData.data[3]!=0;};$.fn.objectHitTest=function(options){var settings=$.extend({'object':null,'transparency':true},options);if(settings.object==null)
return false;var objectRect=this.getRect();var objectToTestRect=settings.object.getRect();var rectsInstersects=objectRect.intersects(objectToTestRect);var elementTarget=this[0];if(!settings.transparency||(!($(elementTarget).is("img"))&&!($(elementTarget).is("canvas"))))
return rectsInstersects;if(!rectsInstersects)
return false;var objectCanvas=getCanvasFromElement(elementTarget);var objectToTestCanvas=getCanvasFromElement(settings.object[0]);if(objectCanvas==null||objectToTestCanvas==null)
return true;var ctxObject=objectCanvas.getContext('2d');var ctxObjectToTest=objectToTestCanvas.getContext('2d');var intersectionRect=objectRect.intersection(objectToTestRect);if(!intersectionRect)
return true;var objectImageData=ctxObject.getImageData(intersectionRect.x-objectRect.x,intersectionRect.y-objectRect.y,intersectionRect.width>0?intersectionRect.width:1,intersectionRect.height>0?intersectionRect.height:1);var objectToTestImageData=ctxObjectToTest.getImageData(intersectionRect.x-objectToTestRect.x,intersectionRect.y-objectToTestRect.y,intersectionRect.width>0?intersectionRect.width:1,intersectionRect.height>0?intersectionRect.height:1);var objectPix=objectImageData.data;var objectToTestPix=objectToTestImageData.data;var nbPixels=objectImageData.width*objectImageData.height*4;for(var i=0;i<nbPixels;i+=4){if(objectPix[i+3]!=0&&objectToTestPix[i+3]!=0)
return true;}
return false;};function getCanvasFromElement(jqElement){var isImg=$(jqElement).is("img");if(!isImg&&!($(jqElement).is("canvas")))
return null;var canvas=isImg?document.createElement('canvas'):jqElement;if(!canvas.getContext)
return null;var ctx;if(isImg){canvas.setAttribute('width',$(jqElement).outerWidth());canvas.setAttribute('height',$(jqElement).outerHeight());ctx=canvas.getContext('2d');ctx.drawImage(jqElement,0,0,$(jqElement).outerWidth(),$(jqElement).outerHeight());}
return canvas;}})(jQuery);function Rectangle(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;this.toString=function(){return'(x='+this.x+', y='+this.y+', width='+this.width+', height='+this.height+')';};this.rectContainsPoint=function(pointX,pointY){return(pointX>=this.x&&pointX<=this.x+this.width&&pointY>=this.y&&pointY<=this.y+this.height);}
this.intersects=function(rect){switch(g_mainGameController.getStageRotation()){case 0:return(this.x<=rect.x+rect.width&&rect.x<=this.x+this.width&&this.y<=rect.y+rect.height&&rect.y<=this.y+this.height);break;case 90:return(this.x<=rect.x+rect.height&&rect.x<=this.x+this.width&&this.y<=rect.y+rect.width&&rect.y<=this.y+this.height);break;case 180:return(this.x<=rect.x+rect.width&&rect.x<=this.x+this.width&&this.y<=rect.y+rect.height&&rect.y<=this.y+this.height);break;case 270:return(this.x<=rect.x+rect.height&&rect.x<=this.x+this.width&&this.y<=rect.y+rect.width&&rect.y<=this.y+this.height);break;}}
this.intersection=function(rect){var highestX=Math.max(this.x,rect.x);var lowestX=Math.min(this.x+this.width,rect.x+rect.width);if(highestX<=lowestX){var highestY=Math.max(this.y,rect.y);var lowestY=Math.min(this.y+this.height,rect.y+rect.height);if(highestY<=lowestY){return new Rectangle(highestX,highestY,lowestX-highestX,lowestY-highestY);}}
return null;}}