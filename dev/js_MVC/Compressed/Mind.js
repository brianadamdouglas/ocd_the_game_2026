var MIND=Controller.extend({construct:function(){this._player;this._thoughtBubble;this._thoughtsQueue;this._thoughtStartPosition;this._triggerOCDInterval;this._OCDIsWorking;this._active;this._mainController;this._checkRadiusInterval;this._triggeredThought;this._exitRadii;this._waitingToFire;},init:function(player,thoughtBubble,mainController){this._player=player;this._thoughtBubble=thoughtBubble;this._mainController=mainController;this._thoughtsQueue=new Array();this._OCDIsWorking=false;this._active=false;this._exitRadii={immobile:100,mobile:150,sticky:150}
this._waitingToFire=false;this.addListners();},addListners:function(){g_eventHandler.addAListener("respondedOCDTrigger",this);g_eventHandler.addAListener("thoughtFired",this);g_eventHandler.addAListener("pauseThought",this);g_eventHandler.addAListener("resumeThought",this);g_eventHandler.addAListener("kill",this);},addThought:function(callerID,thoughtType,objectType,intensity,loc){var exists=false;var existingThought;for(var i=0;i<this._thoughtsQueue.length;i++){if(this._thoughtsQueue[i].callerID==callerID){existingThought=this._thoughtsQueue[i];if(this._triggeredThought.thought!=existingThought.thought){existingThought.thought.setIntensity(existingThought.thought.getIntensity()+1);}
exists=true;break;}}
if(!exists){var thought=new Thought_Controller();thought.init(thoughtType,intensity,loc);var mindObj={thought:thought,active:false,callerID:callerID,objectType:objectType};console.log(mindObj);if(!this._active){this._thoughtsQueue.unshift(mindObj);this._triggeredThought=this._thoughtsQueue[0];}else{this._thoughtsQueue.push(mindObj);this._triggeredThought=this._thoughtsQueue[this._thoughtsQueue.length-1];}}else{if(objectType=="sticky"||objectType=="mobile"){this._triggeredThought=existingThought;existingThought.thought.setLocation(loc);}}
if(!this._active){this.startCheckingRadius();}},fireLatestThought:function(){this._active=true;this._thoughtsQueue[0].active=true;this._thoughtsQueue[0].thought.startObsessing();this._waitingToFire=true;},thoughtFired:function(data){this._thoughtBubble.fireLatestThought(data.type);this._waitingToFire=false;},pauseThought:function(){if(this._waitingToFire){this._thoughtsQueue[0].thought.pauseObsessing();}},resumeThought:function(){if(this._waitingToFire){this._thoughtsQueue[0].thought.resumeObsessing();}},startCheckingRadius:function(){clearInterval(this._checkRadiusInterval);this._checkRadiusInterval=setInterval(this.didPlayerExitRadius.bind(this),(500));},didPlayerExitRadius:function(){var currentLoc=this._mainController.getPlayerLocation();var thought=this._triggeredThought.thought;this._thoughtStartPosition=thought.getLocation();var xDiff=currentLoc.x-this._thoughtStartPosition.x;var yDiff=currentLoc.y-this._thoughtStartPosition.y;var distance=this._exitRadii[this._triggeredThought.objectType];if(Math.sqrt((xDiff*xDiff)+(yDiff*yDiff))<100){}else{clearInterval(this._checkRadiusInterval);this.fireLatestThought();}},isOCDWorking:function(){var currentLoc=this._mainController.getPlayerLocation();var thought=this._thoughtsQueue[0].thought;this._thoughtStartPosition=thought.getLocation();var xDiff=currentLoc.x-this._thoughtStartPosition.x;var yDiff=currentLoc.y-this._thoughtStartPosition.y;if(Math.sqrt((xDiff*xDiff)+(yDiff*yDiff))<50){this._OCDIsWorking=true;}else{this._OCDIsWorking=false;}},respondedOCDTrigger:function(){if(this._triggeredThought.thought!=undefined){console.log(this._triggeredThought);g_eventHandler.dispatchAnEvent("addAssociatedThought",{type:this._triggeredThought.thought.getType()});}
this._active=false;this.isOCDWorking();if(this._OCDIsWorking){var thought=this._thoughtsQueue[0].thought;thought.setIntensity(thought.getIntensity()+1);this._triggeredThought=thought;this.fireLatestThought();}else{var thought=this._thoughtsQueue[0].thought;thought.setIntensity(thought.getIntensity()-1);var moveThought=this._thoughtsQueue.shift();if(thought.getIntensity()>0){this._thoughtsQueue.push(moveThought);}
if(this._thoughtsQueue.length>0){if(!this._thoughtsQueue[0].active){this._triggeredThought=this._thoughtsQueue[0];this.startCheckingRadius();}else{this.fireLatestThought();}}else{console.log("thought queue is empty");this._triggeredThought=undefined;g_eventHandler.dispatchAnEvent("checkPositionForFinish",{type:thought.getType()});}}},kill:function(){this._triggeredThought=undefined;clearInterval(this._checkRadiusInterval);if(this._thoughtsQueue.length>0){for(var i=0;i<this._thoughtsQueue.length;i++){this._thoughtsQueue[i].thought.pauseObsessing();}}
this._thoughtsQueue=new Array();this._OCDIsWorking=false;this._active=false;this._waitingToFire=false;}});